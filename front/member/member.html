<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link href="../../css/member.css" rel="stylesheet">
    <title>Orca_Member</title>
    <style>
        .active {
            display: block;
        }

        .nonactive {
            display: none;
        }

        .card-title {
            font-weight: 700;
        }

        .card-text {
            font-size: 0.8rem;
        }

        .sets-unit,
        .reps-unit {
            font-size: 0.8rem;
        }

        .type-img {
            width: 32px;
            height: 32px;
        }

        .reps,
        .sets {
            font-weight: 500;
        }

        .form-label,
        legend {
            font-size: 1.2rem;
        }

        .form-check-label {
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div id="header-container" class="header-class container-fluid">
        <img src="../../assets/orcalogo.png" height="100" style="margin-left: 50px">
        <h1 id="welcome-h1"></h1>
        <div class="header-button-container">
            <button type="button" class="btn btn-light">All Workouts</button>
            <button type="button" class="btn btn-light">My Workouts</button>
            <button type="button" class="btn btn-danger">Logout</button>
        </div>
    </div>

    <main class="container-md p-4">
        <h3>
            <span></span> Workout Program
        </h3>
        <div class="message-from-instructor nonactive">
            <p>
                Your workouot program curated by your instructor:
                <span>[insructor's name]</span>
            </p>
            <h5>
                Instructor notes:
            </h5>
            <p>
            </p>
        </div>

        <div class="workout">
            <div class="workout-card">
                <!-- workout cards go here... -->
            </div>

            <div class="workout-form-div">
                <div class="workout-form-message">
                    <!-- If workout form hasn't been submitted, messages go here. -->
                </div>
                <form class="workout-form nonactive">
                    <fieldset>
                        <legend>1. Which difficulty level would you like to choose?</legend>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="beginner" name="level" value="beginner"
                                checked />
                            <label class="form-check-label" for="beginner">Beginner</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="intermidiate" name="level"
                                value="intermidiate" />
                            <label class="form-check-label" for="intermidiate">Intermidiate</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="advanced" name="level" value="advanced" />
                            <label class="form-check-label" for="advanced">Advanced</label>
                        </div>
                    </fieldset>

                    <div>
                        <label class="form-label" for="days">2. How many days a week would you like to workout?</label>
                        <select class="form-select" name="days" id="days">
                            <option value="">--Please choose an option--</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                        </select>
                    </div>

                    <div>
                        <label class="form-label" for="instructors">3. Which instructors would you like to work
                            with?</label>
                        <select class="form-select" name="instructors" id="instructors">
                            <option value="">--Please choose an option--</option>
                            <!-- <option value="Arnold">Arnold</option> -->
                        </select>
                    </div>

                    <fieldset>
                        <legend>4. What is your goal with this program?</legend>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="burn fat" name="goal" value="burn fat"
                                checked />
                            <label class="form-check-label" for="burn fat">Burn Fat</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="build muscle" name="goal"
                                value="build muscle" />
                            <label class="form-check-label" for="build muscle">Build Muscle</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="gain strength" name="goal"
                                value="gain strength" />
                            <label class="form-check-label" for="gain strength">Gain Strength</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" id="stay active" name="goal"
                                value="stay active" />
                            <label class="form-check-label" for="stay active">Stay Active</label>
                        </div>
                    </fieldset>

                    <div>
                        <label class="form-label" for="note">5. Tell us your note:</label>
                        <textarea class="form-control" id="note" name="note"></textarea>
                    </div>

                    <button class="btn btn-success align-self-center" type="submit">Send</button>
                </form>
            </div>
        </div>
    </main>



    <script type="module">
        import XMLReq from "../js/XMLReq.js"
        const memberPhp = "http://localhost/FitnessCMS-FinalProject/members.php";
        let xmlReq = new XMLReq(memberPhp);
        let loadData, memberInfo, Instructors;
        let myWorkoutData = [];
        let allWorkoutData = [];
        let workoutDiv = document.querySelector(".workout");
        let workoutCardDiv = document.querySelector(".workout-card");
        let workoutFormDiv = document.querySelector(".workout-form-div");
        let requestForm = document.querySelector(".workout-form");
        let messageBtnDiv = document.querySelector(".workout-form-message");
        let allWorkoutsBtn = document.querySelectorAll("#header-container button")[0];
        let myWorkoutsBtn = document.querySelectorAll("#header-container button")[1];
        let messageFromInstructor = document.querySelector(".message-from-instructor");
        let h3title = document.querySelector("main h3");
        let isMessageFromInstructor = false;

        // Function making request form visible
        // and putting instructors' name to option input.
        const workoutRequestPopper = (e) => {
            e.preventDefault();
            requestForm.classList.remove("nonactive");
            workoutFormDiv.removeChild(messageBtnDiv);
            requestForm.classList.add("active", "d-flex", "flex-column", "justify-content-center", "gap-2");
            let instructorsSelect = document.querySelector("#instructors");
            Instructors.map((Instructor, key) => {
                console.log(Instructor);
                let option = document.createElement("option");
                option.value = Instructor.fname;
                option.textContent = Instructor.fname + ' ' + Instructor.lname;
                instructorsSelect.append(option);
            });
        }

        // Function displaying "messages" from instructor.
        const messageFromInstructorPopper = () => {
            if (messageFromInstructor.classList.contains("nonactive")
                && isMessageFromInstructor) {
                messageFromInstructor.classList.remove("nonactive")
                messageFromInstructor.classList.add("active")
            } else {
                messageFromInstructor.classList.remove("active")
                messageFromInstructor.classList.add("nonactive")
            }
            let span = document.querySelector(".message-from-instructor p span");
            span.textContent = memberInfo.ifname;
            let notes = document.querySelectorAll(".message-from-instructor p")[1];
            notes.textContent = memberInfo.note;
        }

        // Function displaying "cards" of workouts.
        const workoutCardPopper = (data) => {
            console.log(data);
            let cardsField = document.createElement("div");
            cardsField.classList.add("row");
            cardsField.classList.add("row-cols-2");
            cardsField.classList.add("row-cols-md-4");
            // cardsField.classList.add("row-cols-md-4");
            cardsField.classList.add("g-2");
            data.map((workout, key) => {
                let col = document.createElement("div");
                col.classList.add("col");
                let card = document.createElement("div");
                card.classList.add("card", "h-100", "bg-light", "p-2", "row-gap-2", "justify-content-around");
                let image = document.createElement("img");
                image.classList.add("card-img-top", "rounded", "h-auto");
                image.src = '../../assets/image/' + workout.wname + '.jpg';
                image.alt = 'Image of ' + workout.wname;

                let description = document.createElement("div");
                description.classList.add("d-flex", "justify-content-between", "px-2", "align-items-center");
                let smallDiv = document.createElement("div");
                smallDiv.classList.add("d-flex", "flex-column");
                let title = document.createElement("span");
                title.classList.add("card-title");
                title.textContent = workout.wname;
                let target = document.createElement("span");
                target.classList.add("card-text");
                target.textContent = workout.target;
                let type = document.createElement("img");
                type.classList.add("type-img");
                type.src = '../../assets/type/' + workout.type + '.svg';
                type.alt = 'Svg image of ' + workout.type;
                smallDiv.append(title, target);
                description.append(smallDiv, type);

                let setsReps = document.createElement("div");
                setsReps.classList.add("d-flex", "justify-content-around", "align-items-center");
                let setsDiv = document.createElement("div");
                setsDiv.classList.add("d-flex", "flex-column", "justify-content-evenly", "align-items-center");
                let sets = document.createElement("span");
                sets.textContent = workout.reps;
                sets.classList.add("sets");
                let setsText = document.createElement("span");
                setsText.textContent = "sets";
                setsText.classList.add("sets-unit");
                setsDiv.append(sets, setsText);
                let repsDiv = document.createElement("div");
                repsDiv.classList.add("d-flex", "flex-column", "justify-content-evenly", "align-items-center");
                let reps = document.createElement("span");
                reps.textContent = workout.reps;
                reps.classList.add("reps");
                let repsText = document.createElement("span");
                repsText.textContent = "reps";
                repsText.classList.add("reps-unit");
                repsDiv.append(reps, repsText);
                let targetImage = document.createElement("span");
                targetImage.textContent = workout.target;
                setsReps.append(setsDiv, repsDiv, targetImage);

                card.append(image, description, setsReps);
                col.append(card);
                cardsField.append(col);
            })
            workoutCardDiv.append(cardsField);
        }

        // Function to get myworkout data.
        const getMyWorkoutData = () => {
            let reqData = new FormData();
            const mid = sessionStorage.getItem("mid");
            reqData.append("mid", mid);
            reqData.append("mode", "get-my-workouts");
            xmlReq.Post(reqData).then(
                (data) => {
                    // This data should be array.
                    myWorkoutData = JSON.parse(data);
                },
                (rej) => {
                    console.log(rej);
                }
            )
        }

        // Function to get all of workout data.
        const getAllWorkoutData = () => {
            let reqData = new FormData();
            reqData.append("mode", "get-all-workouts");
            xmlReq.Post(reqData).then(
                (data) => {
                    // This data should be array.
                    myWorkoutData = JSON.parse(data);
                },
                (rej) => {
                    console.log(rej);
                }
            )
        }

        // Function producing button taking user to seeing form 
        // or producing workout cards.
        const workoutHandler = () => {
            // below condition is for test
            // if (memberInfo.status===null) {
            // if (memberInfo.status === null || memberInfo.status == "pending") {
            if (memberInfo.status === null || memberInfo.status == "pending") {
                let message = document.createElement("h2");
                message.textContent = "You don't have a workout program yet";
                let requestBtn = document.createElement("button");
                requestBtn.type = "button";
                requestBtn.textContent = "Request Workout";
                requestBtn.classList.add("btn", "btn-success");

                messageBtnDiv.classList.add("d-flex", "flex-column", "justify-content-center", "align-items-center");
                messageBtnDiv.append(message, requestBtn);

                workoutDiv.classList.add("rounded-4", "bg-light", "d-flex", "flex-column", "justify-content-center", "align-items-center", "p-4")
                requestBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    workoutRequestPopper(e);
                })
            } else {
                getMyWorkoutData();
                workoutCardPopper(myWorkoutData);
                isMessageFromInstructor = true;
                messageFromInstructorPopper();
                h3title.children[0].textContent = "My";
            }
        }

        // Refreshing workout cards div.
        const removeCards = () => {
            while (workoutCardDiv.firstChild) {
                workoutCardDiv.removeChild(workoutCardDiv.firstChild);
            }
        }

        // Making form invisible.
        const formInvisible = () => {
            if (!workoutFormDiv.classList.contains("nonactive")) {
                workoutFormDiv.classList.add("nonactive");
            };
        }

        // Add eventlistener to dispaly all workouts
        allWorkoutsBtn.addEventListener("click", (e) => {
            e.preventDefault();
            formInvisible();
            removeCards();
            getAllWorkoutData();
            workoutCardPopper(allWorkoutData);
            isMessageFromInstructor = false;
            messageFromInstructorPopper();
            h3title.children[0].textContent = "All";

        });

        // Add eventlistener to dispaly my workouts
        myWorkoutsBtn.addEventListener("click", (e) => {
            e.preventDefault();
            formInvisible();
            removeCards();
            getMyWorkoutData();
            workoutCardPopper(myWorkoutData);
            isMessageFromInstructor = true;
            messageFromInstructorPopper();
            h3title.children[0].textContent = "My";
        });

        // Add event listener to make and send form request
        // and take user to initial page after submitting form.
        requestForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const sid = sessionStorage.getItem("sid");
            const mid = sessionStorage.getItem("mid");
            let reqData = new FormData(e.target);
            reqData.append("sid", sid);
            reqData.append("mid", mid);
            // After submitting form of workout request.
            reqData.append("status", "pending")
            reqData.append("mode", "form")
            xmlReq.Post(reqData).then(
                (data) => {
                    console.log(data);
                },
                (rej) => {
                    console.log(rej);
                }
            )
            location.reload();
        })


        function load() {
            const sid = sessionStorage.getItem("sid");
            const mid = sessionStorage.getItem("mid");
            let reqData = new FormData();
            reqData.append("sid", sid);
            reqData.append("mid", mid);
            reqData.append("mode", "load")
            xmlReq.Post(reqData).then(
                (data) => {
                    loadData = JSON.parse(data);
                    console.log(loadData);
                    memberInfo = loadData[0];
                    Instructors = loadData[1];
                    allWorkoutData = loadData[2];
                    // Welcome message
                    let h1 = document.querySelector("#welcome-h1");
                    h1.textContent = "Welcome " + memberInfo.fname + "!";
                    workoutHandler();
                },
                (rej) => {
                    console.log(rej);
                }
            )
        }
        load();

    </script>
</body>



</html>